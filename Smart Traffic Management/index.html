<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Smart Traffic Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100%;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5em;
            font-weight: bold;
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-info a {
            color: white;
            margin-left: 15px;
            text-decoration: none;
        }
        nav {
            background-color: #34495e;
            padding: 10px 20px;
        }
        nav a {
            color: white;
            text-decoration: none;
            margin-right: 20px;
            font-size: 0.9em;
        }
        nav a.active {
            font-weight: bold;
            border-bottom: 2px solid white;
        }
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            align-items: center;
        }
        .filter-bar select, .filter-bar input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .filter-bar button {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .filter-bar button:hover {
            background-color: #2980b9;
        }
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .chart-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .chart-card canvas {
            width: 100% !important;
            height: 300px !important;
        }
        .panel-heading {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .table-container {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status-high {
            color: #f44336;
        }
        .status-medium {
            color: #ff9800;
        }
        .status-low {
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Smart Traffic Management</div>
            <div class="user-info">
                <span id="username">Welcome, <span id="user">User</span></span>
                <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </header>
        <nav>
            <a href="/"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="/map"><i class="fas fa-map-marked-alt"></i> Map View</a>
            <a href="/analytics" class="active"><i class="fas fa-chart-line"></i> Analytics</a>
            <a href="/settings"><i class="fas fa-cog"></i> Settings</a>
            <a href="/admin" id="admin-link" style="display:none;"><i class="fas fa-user-shield"></i> Admin</a>
        </nav>
        <div class="content">
            <h1>Traffic Analytics</h1>

            <div class="filter-bar">
                <select id="junction-filter">
                    <option value="all">All Junctions</option>
                    <!-- Junctions will be loaded here -->
                </select>
                <input type="date" id="date-from" value="2025-04-02">
                <span>to</span>
                <input type="date" id="date-to" value="2025-04-09">
                <select id="time-range">
                    <option value="all">All Day</option>
                    <option value="morning">Morning (6:00-10:00)</option>
                    <option value="midday">Midday (10:00-14:00)</option>
                    <option value="afternoon">Afternoon (14:00-18:00)</option>
                    <option value="evening">Evening (18:00-22:00)</option>
                    <option value="night">Night (22:00-6:00)</option>
                </select>
                <button id="apply-filters"><i class="fas fa-filter"></i> Apply</button>
                <button id="export-data"><i class="fas fa-download"></i> Export</button>
            </div>

            <div class="stats-row">
                <div class="stat-card">
                    <h3>Average Wait Time</h3>
                    <div class="stat-value">45s</div>
                    <div>Across all junctions</div>
                </div>
                <div class="stat-card">
                    <h3>Peak Traffic Time</h3>
                    <div class="stat-value">8:15 AM</div>
                    <div>Highest vehicle count</div>
                </div>
                <div class="stat-card">
                    <h3>Most Congested</h3>
                    <div class="stat-value">East</div>
                    <div>Direction with highest traffic</div>
                </div>
                <div class="stat-card">
                    <h3>Emergency Events</h3>
                    <div class="stat-value">3</div>
                    <div>In selected time period</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-card">
                    <div class="panel-heading">Traffic Flow by Hour</div>
                    <canvas id="hourlyTrafficChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="panel-heading">Traffic Distribution by Direction</div>
                    <canvas id="directionTrafficChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-card">
                    <div class="panel-heading">Average Wait Time by Junction</div>
                    <canvas id="waitTimeChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="panel-heading">Traffic Density Trend</div>
                    <canvas id="densityTrendChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <div class="panel-heading">Traffic Events Log</div>
                <table id="events-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Junction</th>
                            <th>Event Type</th>
                            <th>Direction</th>
                            <th>Details</th>
                            <th>Severity</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table rows will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
          

            // Load junctions for the filter dropdown
            loadJunctions();

            // Initialize charts
            initCharts();

            // Load events table data
            loadEventsData();

            // Set up filter button
            document.getElementById('apply-filters').addEventListener('click', function() {
                loadAnalyticsData();
            });

            // Export data button
            document.getElementById('export-data').addEventListener('click', function() {
                exportData();
            });
        });

        function loadJunctions() {
            fetch('/api/junctions')
                .then(response => response.json())
                .then(data => {
                    const junctionFilter = document.getElementById('junction-filter');

                    for (const junctionId in data) {
                        const option = document.createElement('option');
                        option.value = junctionId;
                        option.textContent = junctionId;
                        junctionFilter.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error loading junctions:', error);
                });
        }

        function initCharts() {
            // Hourly Traffic Chart
            const hourlyCtx = document.getElementById('hourlyTrafficChart').getContext('2d');
            const hourlyChart = new Chart(hourlyCtx, {
                type: 'line',
                data: {
                    labels: ['12 AM', '2 AM', '4 AM', '6 AM', '8 AM', '10 AM', '12 PM', '2 PM', '4 PM', '6 PM', '8 PM', '10 PM'],
                    datasets: [{
                        label: 'Vehicle Count',
                        data: [5, 3, 2, 8, 30, 25, 18, 20, 22, 28, 15, 8],
                        borderColor: '#3498db',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Vehicles'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            }
                        }
                    }
                }
            });

            // Direction Traffic Chart
            const directionCtx = document.getElementById('directionTrafficChart').getContext('2d');
            const directionChart = new Chart(directionCtx, {
                type: 'pie',
                data: {
                    labels: ['North', 'South', 'East', 'West'],
                    datasets: [{
                        data: [25, 20, 35, 20],
                        backgroundColor: ['#1abc9c', '#3498db', '#9b59b6', '#e74c3c'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });

            // Wait Time Chart
            const waitTimeCtx = document.getElementById('waitTimeChart').getContext('2d');
            const waitTimeChart = new Chart(waitTimeCtx, {
                type: 'bar',
                data: {
                    labels: ['Junction1', 'Junction2', 'Junction3'],
                    datasets: [{
                        label: 'Average Wait Time (seconds)',
                        data: [45, 38, 52],
                        backgroundColor: '#f39c12',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Seconds'
                            }
                        }
                    }
                }
            });

            // Density Trend Chart
            const densityCtx = document.getElementById('densityTrendChart').getContext('2d');
            const densityChart = new Chart(densityCtx, {
                type: 'line',
                data: {
                    labels: ['Apr 2', 'Apr 3', 'Apr 4', 'Apr 5', 'Apr 6', 'Apr 7', 'Apr 8', 'Apr 9'],
                    datasets: [{
                        label: 'Average Traffic Density',
                        data: [45, 48, 52, 40, 35, 50, 55, 48],
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Density %'
                            }
                        }
                    }
                }
            });
        }

        function loadEventsData() {
            // In a real application, this would fetch from the backend
            // For now, we'll use mock data
            const eventsData = [
                { time: '2025-04-09 08:15:22', junction: 'Junction1', type: 'High Traffic', direction: 'East', details: 'Traffic density exceeds 75%', severity: 'high' },
                { time: '2025-04-09 09:30:15', junction: 'Junction1', type: 'Emergency Vehicle', direction: 'North', details: 'Ambulance detected', severity: 'high' },
                { time: '2025-04-09 12:45:33', junction: 'Junction2', type: 'Signal Malfunction', direction: 'All', details: 'Red light stuck for 3 minutes', severity: 'medium' },
                { time: '2025-04-09 15:20:11', junction: 'Junction3', type: 'High Traffic', direction: 'West', details: 'Traffic density exceeds 65%', severity: 'medium' },
                { time: '2025-04-08 17:45:06', junction: 'Junction2', type: 'Weather Alert', direction: 'All', details: 'Heavy rain affecting visibility', severity: 'medium' },
                { time: '2025-04-08 14:10:28', junction: 'Junction1', type: 'Accident', direction: 'South', details: 'Minor collision, lane partially blocked', severity: 'high' },
                { time: '2025-04-07 08:30:55', junction: 'Junction3', type: 'Pedestrian Crossing', direction: 'North', details: 'Unusual high pedestrian activity', severity: 'low' }
            ];

            const tbody = document.querySelector('#events-table tbody');
            tbody.innerHTML = ''; // Clear existing rows

            eventsData.forEach(event => {
                const row = document.createElement('tr');

                // Format the time to be more readable
                const dateTime = new Date(event.time);
                const formattedTime = dateTime.toLocaleString();

                row.innerHTML = `
                    <td>${formattedTime}</td>
                    <td>${event.junction}</td>
                    <td>${event.type}</td>
                    <td>${event.direction}</td>
                    <td>${event.details}</td>
                    <td class="status-${event.severity}">${event.severity.charAt(0).toUpperCase() + event.severity.slice(1)}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function loadAnalyticsData() {
            // Get filter values
            const junction = document.getElementById('junction-filter').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            const timeRange = document.getElementById('time-range').value;

            console.log(`Loading data for ${junction} from ${dateFrom} to ${dateTo}, time range: ${timeRange}`);

            // In a real application, this would make an API call with these parameters
            // For demonstration, we'll just show an alert and refresh the current data
            alert(`Filters applied: Junction=${junction}, Date Range=${dateFrom} to ${dateTo}, Time=${timeRange}`);

            // Simulate updated data for charts
            updateCharts(junction, dateFrom, dateTo, timeRange);

            // Reload events table with filtered data
            loadEventsData();

            // Update statistics cards
            updateStats(junction, dateFrom, dateTo, timeRange);
        }

        function updateCharts(junction, dateFrom, dateTo, timeRange) {
            // In a real application, this would update charts with new data from API
            // For demonstration, we'll just update with random data

            // Update hourly traffic chart
            const hourlyChart = Chart.getChart('hourlyTrafficChart');
            if (hourlyChart) {
                const newData = Array(12).fill().map(() => Math.floor(Math.random() * 40) + 5);
                hourlyChart.data.datasets[0].data = newData;
                hourlyChart.update();
            }

            // Update direction chart (for specific junctions only)
            if (junction !== 'all') {
                const directionChart = Chart.getChart('directionTrafficChart');
                if (directionChart) {
                    const newData = [
                        Math.floor(Math.random() * 30) + 10,
                        Math.floor(Math.random() * 30) + 10,
                        Math.floor(Math.random() * 30) + 10,
                        Math.floor(Math.random() * 30) + 10
                    ];
                    directionChart.data.datasets[0].data = newData;
                    directionChart.update();
                }
            }

            // Update wait time chart
            const waitTimeChart = Chart.getChart('waitTimeChart');
            if (waitTimeChart) {
                if (junction !== 'all') {
                    // If specific junction selected, only show that junction
                    waitTimeChart.data.labels = [junction];
                    waitTimeChart.data.datasets[0].data = [Math.floor(Math.random() * 30) + 30];
                } else {
                    // Otherwise show all junctions
                    waitTimeChart.data.labels = ['Junction1', 'Junction2', 'Junction3'];
                    waitTimeChart.data.datasets[0].data = [
                        Math.floor(Math.random() * 30) + 30,
                        Math.floor(Math.random() * 30) + 30,
                        Math.floor(Math.random() * 30) + 30
                    ];
                }
                waitTimeChart.update();
            }

            // Update density trend chart based on date range
            const densityChart = Chart.getChart('densityTrendChart');
            if (densityChart) {
                // Create labels for the date range
                const start = new Date(dateFrom);
                const end = new Date(dateTo);
                const labels = [];
                const newData = [];

                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    labels.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    newData.push(Math.floor(Math.random() * 30) + 30);
                }

                densityChart.data.labels = labels;
                densityChart.data.datasets[0].data = newData;
                densityChart.update();
            }
        }

        function updateStats(junction, dateFrom, dateTo, timeRange) {
            // Update statistics cards with random values
            document.querySelector('.stats-row .stat-card:nth-child(1) .stat-value').textContent =
                `${Math.floor(Math.random() * 30) + 30}s`;

            document.querySelector('.stats-row .stat-card:nth-child(2) .stat-value').textContent =
                `${Math.floor(Math.random() * 12) + 7}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')} ${Math.random() > 0.5 ? 'AM' : 'PM'}`;

            const directions = ['North', 'South', 'East', 'West'];
            document.querySelector('.stats-row .stat-card:nth-child(3) .stat-value').textContent =
                directions[Math.floor(Math.random() * directions.length)];

            document.querySelector('.stats-row .stat-card:nth-child(4) .stat-value').textContent =
                Math.floor(Math.random() * 5) + 1;
        }

        function exportData() {
            // Get filter values
            const junction = document.getElementById('junction-filter').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            const timeRange = document.getElementById('time-range').value;

            // In a real application, this would generate and download a CSV/Excel file
            // For demonstration, we'll just show an alert
            alert(`Exporting data for ${junction} from ${dateFrom} to ${dateTo}, time range: ${timeRange}.\n\nIn a real application, this would download a CSV or Excel file with the filtered data.`);

            // Mock download process
            setTimeout(() => {
                const filename = `traffic_analytics_${junction}_${dateFrom}_${dateTo}.csv`;
                console.log(`Download started: ${filename}`);
            }, 1000);
        }
    </script>
</body>
</html>